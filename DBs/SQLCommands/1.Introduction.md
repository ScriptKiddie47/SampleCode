# SQL 

### Note : The Commands here are based on the DB defined in Postgres docker file based on dvdrental DB

## SELECT
```sql
select customer_id,last_name ,email  from customer;
```

## DISTINCT ( Unique )
```sql
select distinct rental_rate from film
select distinct (rating) from film
```
## COUNT
```sql
select count(rating) from film
select count(distinct (rating)) from film  
```
## WHERE

1. When comparing string the case matters

```sql
select * from customer where first_name = 'Jared'
select * from film where rental_rate > 4
select * from film where rental_rate > 4 and replacement_cost >= 19.99
select * from film where rental_rate > 4 and replacement_cost >= 19.99 and rating = 'R'
select film_id,rating from film where rating = 'R' or rating = 'PG-13'
select * from film where rating != 'R'
```

## OREDER BY
1. Numberic,Date or Alphabetical
2. Default is Ascending
```sql
select * from customer order by first_name;
select * from customer order by first_name ASC;
select store_id,first_name,last_name from customer order by store_id DESC,first_name ASC;
select * from payment order by payment_date DESC;
```

## LIMIT
```sql 
select * from payment order by payment_date desc limit 5
```
## BETWEEN

1. Can be usec with Dates as well.
2. Dates should be ISO 8601 standard format.3
3. When dealing with Date becareful

```sql
select * from payment where amount between 8 and 9
select * from payment where amount not between 8 and 9
select * from payment where payment_date between '2007-02-01' and '2007-02-15' 
```

## IN
```
select * from payment where amount in ( 0.99,1.98,1.99)
select * from payment where amount not in ( 0.99,1.98,1.99)
select * from customer where first_name in ( 'John','Jake','Julie')
```

## LIKE
1. Perform Pattern Matching against String values with the usage of wildcard
2. `ILIKE` is case in sensitive 
```sql
select * from customer where first_name like 'J%' --Everyone whos first name starts with the letter J

select * from customer where first_name like 'J%' and last_name like 'S%' -- first name starts with the letter J and last name starts with capital S 

select * from customer where first_name ilike 'j%' and last_name ilike 's%' -- Disable Case Sensitivity.

select * from customer where first_name like '%er%' --Anyone who has 'er' somewhere in their first name. er at the start/end is valid as well. eg : Heather

select * from customer where first_name like '_her%' -- Only one character is allowed before 'er' keyword. eg : Catherine,Theresa..!

select * from customer where first_name not like '_her%'
select * from customer where first_name like 'A%' and last_name not like 'B%' order by last_name --first name starts with caps 'A' & last name doesn't start with caps 'B'

select customer_id,first_name,address_id from customer
where address_id < 500 and first_name like 'E%'
order by customer_id desc
limit 1 -- What customer has the highest customer ID number whose name starts with an 'E' and has an address ID lower than 500?
```

## Aggregate Functions
1. URL : https://www.postgresql.org/docs/9.5/functions-aggregate.html
2. Only works with Select & Having clause
3. Special Note :
AVG() returns a floating point value. Use Round() to specify precision
```sql
select min(replacement_cost) from film;
select max(replacement_cost) from film;
select min(replacement_cost),max(replacement_cost) from film;
select avg(replacement_cost) from film; -- Output: 19.9840000000000000
select round(avg(replacement_cost),2) from film; -- Rounded to 2 decimal places , output : 19.98
select sum(replacement_cost) from film;
```

## GROUP BY 
### Allows us to aggregate columns per some category
1. Choose a `categorical column`
2. Split the table based on a category
3. Then use a aggregate function to join the data
4. `GROUP BY` clause must appear right after a FROM or WHERE statement.
5. In the select statement , columns must either have an aggregate function or be in a group by call
6. Where statement should not refer to the aggregation result. We can use `having` for that later.
7. If you want to sort results based on aggregate, make sure to reference the entire function
```sql
select customer_id from payment
group by customer_id
order by customer_id -- This is essentially the same as distinct

select customer_id,sum(amount) from payment
group by customer_id
order by customer_id -- Total sum every customer spent

select customer_id,sum(amount) from payment
group by customer_id
order by sum(amount) -- Same as above , modified the order

select customer_id,COUNT(amount) from payment
group by customer_id
order by count(amount) desc -- count how many transaction a customer is having

select staff_id,customer_id,sum(amount) from payment
group by staff_id,customer_id  /*Total amount spent per staff per customer

staff_id|customer_id|sum   |
--------+-----------+------+
       2|          1| 53.85|
       1|          1| 60.85|
So it looks like customer 1 spent $60.85 with staff 1. Then $53.85 with staff 2
*/

select DATE(payment_date),sum(amount) from payment
group by DATE(payment_date)
order by sum(amount) -- total $$ processed each day

select staff_id,count(payment_id) from payment
group by staff_id -- how many payments did each staff memeber handle

select rating,round(avg(replacement_cost),2) from film
group by rating
order by round(avg(replacement_cost),2) -- average replacement cost per MPAA rating

select customer_id,sum(amount) from payment
group by customer_id
order by sum(amount) desc
limit 5 -- Customer ID's of the top  5 customer by Total Spend
```
## HAVING 
1. Allows us to filter an aggregation has already taken place
```sql
select customer_id,sum(amount) from payment
group by customer_id
having sum(amount) > 100 -- Only consider the amout total which exceeds 100

select store_id,count(*) from customer
group by store_id
having count(*) > 300

select store_id,count(customer_id) from customer
group by store_id
having count(customer_id) > 300

select customer_id,count(amount) from payment
group by customer_id
having count(amount) >= 40
order by count(amount) desc -- Customers that had 40 or more transaction payments.

select customer_id,staff_id,sum(amount) from payment
where staff_id = 2
group by customer_id,staff_id
having sum(amount) > 110
order by customer_id --  Return the customer IDs of customers who have spent at least $110 with the staff member who has an ID of 2.
```

## Alias
```sql
select amount as rental_price from payment -- Output will come as rental_price
select sum(amount) as net_revenue from payment 
```

#### Note : `as` operator executes at the very end of the query , so we cannot execute it at the very end.

## Joins

Reference : https://blog.codinghorror.com/a-visual-explanation-of-sql-joins/

## Date & Time
```sql
-- Suppose payment_date is '2007-02-15 22:25:46.996'
select DATE(payment_date) from payment -- Filter out date from timestamp. Output - 2007-02-15
```

select max(customer_id) from customer 
where first_name like 'E%' and address_id < 500
limit 1
